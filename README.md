# H-Bridge Driver on ATTiny-2313

## General Description

### Circuit (Hardware)

1. **What is the circuit for, what does the circuit do.**
The H-Bridge circuit with the ATTiny2313 microcontroller is designed to work with bipolar microstepping motors, which can be found in DVD drives. Version v.0.1.1 of the circuit is very simplified and uses low-power (less than 1A) BJT transistors as switching elements. The microcontroller can control such transistors without additional active elements. Although some security elements have been added to the circuit.
2. **General design of the circuit.** 
    1. **Listing all blocks of the circuit.** The circuit version v.0.1.1 consists of four large blocks: 
        1. Microcontroller;  
        2. Two H-Bridge circuits; 
        3. A bipolar microstepping motor unit; 
        4. A power supply.
    2. **Description of possible circuit configurations at the block level.** The simplicity of the circuit led to the presence of only one configuration: Direct connection of one of the microcontroller ports to the bases of BJT transistors in the H-Bridge circuits. And two lines from another microcontroller port are directly connected to the photointerrupters outputs in the stepper motor unit. The microstepping motor is powered and controlled via the H-Bridge circuits. The H-Bridge outputs are directly connected to the microstepping motor. The power supply supplies power to the microcontroller, H-Bridge circuit and photointerrupters in the microstepper motor block.
3. **Detailed description of the H-Bridge circuit.**
    1. **Description of the operation of each individual block of the circuit.**
        1. From an electronics point of view, the microcontroller unit is very simple. It contains ATTiny2313/ATTiny2313A/ATTiny2313V series microcontroller. Power is supplied to the microcontroller. The simplest HF and LF filters are the corresponding capacitors located physically close to the power lines and GND of the microcontroller. ATTiny2313 has internal pull-up resistors on the RESET line and an advanced reset algorithm when power is turned on (see Datasheet). Therefore, external elements for this purpose were not added to the circuit. Fuses have not been changed, so the internal oscillator with a frequency of 8MHz and a frequency division of 8 times will be used.
        2. Version v.0.1.1 of the H-Bridge circuit was designed to drive low power bipolar microstepper motor. Supply voltage is assumed to be 5V. There are two (sets of) coils in the bipolar stepper motor, so there are two H-Bridges for the bipolar stepper motor. One H-Bridge per coil - call it H-Bridge 1 and H-Bridge 2. Each H-Bridge has two "sides" - "left side" and "right side". Each side has tow "halves" - "upper half" and "lower half". Version v.0.1.1 of the H-Bridge circuit uses low power (less than 1A) BJT transistors. The microcontroller controls such transistors without additional active elements. Although some protection elements have been added to the circuit. Therefore version v.0.1.1 of the H-Bridge circuit has 4 control lines: "upper-lef", "upper-right", "lower-left", "lower-right". The "upper" control lines provide connection to the positive pole. The switches in the upper control lines are PNP transistors, The circuit parameters have been calculated so that they are activated/deactivated by signals <1V / >2V. The "lower" controls lines provide connection to negative pole (GND). The switches in the lower control lines are NPN transistors. The circuit parameters have been calculated so that they are activated/deactivated by signals >3V / <1.5V. In both cases, the signals are generated by microcontroller (<0.3V / >4.5V - logic 0/1) are sufficient to ensure stable and correct operation of H-Bridge circuit. The total base current are much less than the maximum permissible value for ATTiny2313(A, V, ...). Therefore in the version v.0.1.1 of the circuit, the BJT switches are activated/deactivated by logic 1/0 (0/1) generated by the microcontroller directly. The coil will be activated if current in the H-Bridge flows from the positive pole on one side, through the coil to the negative pole (GND) of the other side. If this condition is not met the coil will not be activated. If the same poles of both sides are activated, than the current should not actually flow through the coil, because there is not potential difference. If both poles of one side are activated, a "short circuit" is created and the H-Bridge circuit is damaged. Therefore this is a prohibited combination. This also means that it is not possible to activated all control lines at the same time. This solution is not optimal or the best possible, but it is very simple and it provides maximum control flexibility - each (BJT) switch in the circuit is controled separately. This solution is good for demonstration and research purposes.
        3. The microstepping motor unit includes: 
            * frame; 
            * microstepping motor; 
            * a carriage that, when the engine rotates, moves linearly along the frame between two boundary positions; 
            * two photointerrupters, which are located so that the carriage, when reaching the limit position, closes one of the photointerrupters, and current begins to flow through the photointerrupter. Attempting to continue moving the carriage when the limit position is reached may result in mechanical failure of the unit.
        4. The power source provides stabilized DC with a voltage of 5V and a current of at least 2A. The circuit does not require precise stabilization, but fluctuations should not exceed +-5%.
    2. **Description of possible configurations and operating modes of circuit blocks.**
        1. In this version of the circuit, from an electronics point of view, the microcontroller has one configuration. All features of the microcontroller relate to software control.The power supply for the circuit version v.0.1.1 has a single configuration: 5V, 2A.
        2. Version v.0.1.1 of the H-Bridge circuit is designed as a simple circuit with low-power (up to 1A) BJT transistors, and it has a single configuration.
        3. The microstepping motor block can use two photointerrupters, one photointerrupter, or none. This is at the discretion of the program.
        4. The power supply for the circuit version v.0.1.1 has a single configuration: 5V, 2A.       
    3. **Description of possible interactions of circuit blocks in different configurations.** Version v.0.1.1 of the H-Bridge circuit controls a bipolar stepper motor, which has two (sets of) coils. Therefore, in reality the circuit has two independent H-Bridges - one H-Bridge per (set of) coil. Each H-Bridge has 4 input switch control lines in the circuit, so the entire circuit has 8 switch control lines in total. Two more lines are required for the photointerrupter in the microstepper motor unit. (And in the future two lines are planned for the I2C control line). The ATTiny2313 meets these requirements as it has 8 available lines on PORTB, 7 available lines on PORTD, and 3 available lines on PORTA. This series of microcontrollers also satisfies the requirements for voltage and power consumption, as well as the requirements for the sum of currents flowing through all inputs/outputs.The operating speed of the ATTiny2313 is acceptable for the task at hand, so the delays of the transmitted signals do not matter.

    4. **Transmitted signals, combinations of signals, sequences of signals, sequences of combinations of signals. Reactions to signals, combinations of signals, sequences of signals and sequences of combinations of signals. Expected results. Possible incorrect results.** Signals are generated and transmitted from blocks to blocks that make up the circuit. In version v.0.1.1, all signal exchange is carried out between the microcontroller unit and other circuit blocks. Signal exchange between the microcontroller and the H-Bridge circuits occurs via (4x2) 8 control lines. For both H-Bridges, the signal structure is identical. Microcontroller produces outputs in the form of logic 0 (0 - 0.3 V) and logic 1 (4.5 - 5 V). These outputs from the microcontroller are fed to the inputs of the H-Bridge circuits. The following will list and describe combinations of values on the control lines for 1 H-Bridge circuit. (The second H-Bridge will be identical):
 (upper-left)  (upper-right) 
 (lower-left)  (lower-right) 
For example
 1  1 
 0  0 
        * Idling or stall combinations.
        The following will list and describe combinations which do not activate coil. 
            1  1 
            0  0 
           Combination of completely deactivated control lines.
            0  0 
            0  0 
           Combination with both upper control lines activated and both lower control lines not activated.
            1  1 
            1  1 
           Combination with both upper control lines not activated and both lower control lines activated.
           0 1 | 1 0
           0 0 | 0 0 
           Two combinations with one upper control line activated and one upper control line not activated and both lower control line not activated.
           1 1 | 1 1 
           1 0 | 0 1 
           Two combinations with both upper control line not activated and one lower control line activated and one lower control line not activated.
        * Active combinations
        The following will describe two combinations which activate coil.
          0 1 | 1 0
          0 1 | 1 0
          Two combinations with one upper control line activated and opposite lower control line activated and second control line not activated and opposite control line not activated. These two combinations activate coil in opposite directions.
        * Prohibited combinations
        The following will list prohibited combinations (which create a short circuit)
        0 1 | 0 1 | 1 0 | 1 0
        1 0 | 1 1 | 0 1 | 1 1
        These combinations have one upper control line activated, same side lower control line also activated and second upper control line is not activated, same side lower control line could be activated and not activated.            
        0 0 | 0 0 
        1 0 | 0 1
        These two combinations have both upper control lines activated and one lower control line not activated and second lower control line activated. 
        0 0 
        1 1 
        This combination has all control lines activated.

    The exchange of signals between the microcontroller and photointerrupters in the microstepping motor unit occurs along two lines. Photointerrupters normally are in closed state. Current does not flow through photointerrupter and pull-up resistor provide stable logic 1 (>4.5 V) on it output. When the carriage reaches the limit position, it opens the corresponding photointerrupter and current begins to flow through its phototransistor. This provides a logic 0 (< 0.5 V) at its output. (Contact bounce was not taken into account in the electronic circuit and was not smoothed out.) These logical 0 and logical 1 are sent to the input of the microcontroller, where they are perceived and processed in software.      


    5. **Possible uncertainties in the joint operation of circuit blocks.**  TBDL.

### Program (Software)

1. **What is the program for, what does the program do.**
The H-Bridge Driver on ATTiny2313 is a program that runs on ATTiny2313 series microcontroller and it controls the operation of a bipolar stepper motor through a H-Bridge circuits. Version v.0.1.1 of the H-Bridge driver on ATTIny2313 is designed to work with H-Bridge circuit version v.0.1.1.
2. **General program design.**
Since the H-Bridge Driver controls the stepper motor, it determines when the next step should take place using output signals. The sequence of signals also determines in which direction the stepper motor shaft rotates (clockwise or counterclockwise), and the granularity of the motor steps (step/half-step).
The moments of each next step are determined by a timer, the frequency of which can be changed at any time after initialization of the circuit. The timer, in turn, causes an interrupt and calls the interrupt handling function, where it is determined which step/half-step the microstepper motor should take (in which direction). Thus, the frequency of the timer determines the speed of rotation of the motor shaft. The moments of each next step are determined by a timer, the frequency of which can be changed at any time after initialization of the circuit. The rotation of the microstepping motor shaft causes the carriage to move linearly along the frame. When the carriage reaches the limit position on one of the sides of the frame, the photointerrupter generates a signal causing an external interruption (one of two, corresponding to the triggered photointerrupter). This interrupt stops the motor from rotating (and therefore the carriage) and resets the internal program variables responsible for keeping the motor rotating. 
    1. **Listing of all program blocks (subroutines and large logical blocks in the program and subroutines).** H-Bridge Driver on ATTiny2313 consists of:
          1. Main() functions. This function has an initialization block and an (infinite) main loop. The initialization block initializes the microcontroller subsystems after turning on the power. In version v.0.1.1, the main loop runs indefinitely and does not allow the program to terminate without the intervention of a third party (for example, turning off the power). It also performs test and demonstration activities.
          2. Functions set_direction_to_initial_position(...). This function sets an internal variable that determines the direction in which the motor shaft must rotate (clockwise/counterclockwise) in order for the carriage to move towards the starting position. This function takes one variable - the direction of movement towards the starting position. The function does not return any values.
          3. Functions set_stepping_speed(...). This function sets the speed of steps by setting the number of milliseconds between two consecutive steps. Since the timer parameters are changing, all interrupts are disabled. Interrupts are enabled before the function exits. The function takes one parameter - the number of milliseconds between two steps. The function does not return any values.
          4.  Functions stop_movements(...). This function resets the remaining step counter and disables timer interrupts, which stops any changes in the output signals to the H-Bridge and therefore stops the rotation of the stepper motor shaft. These actions are carried out between the interrupt disable/enable pair. The function does not accept parameters and does not return values.
          5. Functions set_number_of_steps(...). This function stops the current rotation of the stepper motor, if any. It then sets the new number of steps to take and starts the timer, allowing timer interrupts. These two actions occur between the interrupt disable/enable pair. The function takes one parameter - the number of steps to take. The function does not return any values.
          6. Functions set_half_full_step_mode(...). This function stops the current rotation of the motor. Then it sets the requested full step/half step mode to the internal variable mode. This action occurs between the interrupt disable/enable pair. The function takes one parameter - full step/half step mode. The function does not return any values.
          7. Function ISR(TIMER1_COMPA_vect). This function is an interrupt handler for a timer (in this case, TIMER1). The interrupt handler is called every time the counter from the timer reaches the value specified during initialization/installation. In this case, both timer interrupts and global interrupts must be enabled. TIMER1 is assigned for motion service only. Therefore, the interrupt handler checks the current state of the stepper motor windings (activated/deactivated), direction of rotation, step/half-step mode in the "mode" variable. Based on this information, it sets a new state for the windings, which determines the next step of the motor. In this case, the counter of remaining steps is decreased by 1. If the counter of remaining steps was equal to 0, then the function does nothing and disables interrupts by the TIMER1 timer.
          8. Function ISR(INT0_vect). This function is an external interrupt handler on the INT0 line. This interrupt handler is called every time a value change occurs on the INT0 line. In this case, external interrupts on the INT0 pin must be enabled, and global interrupts must be enabled. Since the INT0 pin is connected to the output from photointerrupter 1, which is located in the starting position of the frame, changing values ??from logical 1 to logical 0 means that the carriage has reached the starting position. The operating mode must be set to working, the direction of movement must be set in the opposite direction from the beginning. The remaining step counter is set to 0 and timer interrupts are disabled, stopping all movement. If the value on the INT0 pin changes from logical 0 to logical 1, this means that the carriage has left the initial position. Then the counter of the remaining steps is not reset, the timer interrupt is not disabled, that is, the movement does not stop.
          9. Function ISR(INT1_vect). This function is an external interrupt handler on the INT1 line. This interrupt handler is called every time a value change occurs on the INT1 line. In this case, external interrupts on the INT1 pin must be enabled, and global interrupts must be enabled. Since the output from photointerrupter 2, which is located in the final position of the frame, is connected to the INT1 pin, a change in values ??from logical 1 to logical 0 means that the carriage has reached the final position. If the operating mode was “initialization”, then the internal variable direction_to_initial_position is changed to the opposite and initialization is repeated again. That is, the carriage must go to the starting position. In this case, the direction of movement is set to the opposite, the counter of the remaining steps is set to MAX_STEPS. The next initialization action will bring the carriage to its starting position. If the operating mode was “working”, then the direction of movement should be set in the opposite direction from the final position. The remaining step counter is set to 0 and timer interrupts are disabled, stopping all movement. If the value on the INT1 pin changes from logical 0 to logical 1, this means that the carriage has left its final position. Then the counter of the remaining steps is not reset, the timer interrupt is not disabled, that is, the movement does not stop.

    2. **Description of the program configuration at the block level.**
    3. **Description of the operation of each subroutine or selected large block in the program and subroutines.**
    4. **Description of possible configurations and operating modes of subroutines and selected large blocks in the program and subroutines.**
    5. **Description of possible interactions between subroutines and selected large blocks in the program and subroutines.**


## Installation
This application is part of CI/CD process. The process of versioning, updating, building and uploading - TBDL.

## API
### Version v.0.1.1.
None (in this version)

## Notable Related Libraries.
### Version v.0.1.1.
None (in this version)



